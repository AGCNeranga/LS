<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dispatch Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  /* ... Your same styles unchanged ... */
</style>
</head>
<body>

<h2>Dispatch Tracker</h2>

<!-- LOGIN -->
<form id="loginForm">
  <input type="text" id="username" placeholder="Username" required>
  <div class="password-container">
    <input type="password" id="password" placeholder="Password" required>
    <span class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</span>
  </div>
  <button type="submit">Login</button>
</form>

<!-- MAIN APP -->
<div id="app" style="display:none;">
  <p>Logged in as: <span id="currentUser"></span> (<span id="role"></span>)
    <button onclick="logout()">Logout</button>
  </p>

  <div id="adminControls" style="text-align:center; margin-bottom:10px; display:none;">
    <button onclick="clearAllData()">Admin: Clear All Records</button>
  </div>

  <!-- Filters -->
  <div id="filters" style="display:none;">
    <select id="filterDept">
      <option value="">All Departments</option>
      <option value="SPORTS">SPORTS</option>
      <option value="Racing UK">Racing UK</option>
      <option value="Racing AUS">Racing AUS</option>
    </select>
    <select id="filterSection">
      <option value="">All Sections</option>
      <option value="1st Section">1st Section Sport Publication</option>
      <option value="2nd Section">2nd Section Sport Publication</option>
      <option value="1st Section UK">1st Section UK Publication</option>
      <option value="2nd Section UK">2nd Section UK Publication</option>
      <option value="1st Section RST UK">1st Section RST UK Publication</option>
      <option value="2nd Section RST UK">2nd Section RST UK Publication</option>
      <option value="AUS Publication">AUS Publication</option>
      <option value="AUS RST">AUS RST Publication</option>
    </select>
    <button onclick="applyFilter()">Filter</button>
    <button onclick="clearFilter()">Clear Filter</button>
  </div>

  <form id="dispatchForm">
    <input type="date" id="date" required>
    <select id="department" required>
      <option value="">Select Department</option>
      <option value="SPORTS">SPORTS</option>
      <option value="Racing UK">Racing UK</option>
      <option value="Racing AUS">Racing AUS</option>
    </select>
    <select id="section">
      <option value="">Select Section</option>
      <option value="1st Section" data-department="SPORTS">1st Section Sport Publication</option>
      <option value="2nd Section" data-department="SPORTS">2nd Section Sport Publication</option>
      <option value="1st Section UK" data-department="Racing UK">1st Section UK Publication</option>
      <option value="2nd Section UK" data-department="Racing UK">2nd Section UK Publication</option>
      <option value="1st Section RST UK" data-department="Racing UK">1st Section RST UK Publication</option>
      <option value="2nd Section RST UK" data-department="Racing UK">2nd Section RST UK Publication</option>
      <option value="AUS Publication" data-department="Racing AUS">AUS Publication</option>
      <option value="AUS RST" data-department="Racing AUS">AUS RST Publication</option>
    </select>

    <label for="pageCTP">Page CTP</label>
    <input type="time" id="pageCTP">

    <label for="dispatchReceived">Dispatch Received</label>
    <input type="time" id="dispatchReceived">

    <label for="departure">Departure</label>
    <input type="time" id="departure">

    <input type="text" id="notes" placeholder="Notes">

    <label style="display:flex; align-items:center; gap:5px;">
      <input type="checkbox" id="departureAll"> Departure All
    </label>

    <button type="submit">Add Record</button>
    <button type="button" id="exportExcel">Export Excel</button>
  </form>

  <table id="dispatchTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Department</th>
        <th>Section</th>
        <th>Page CTP</th>
        <th>Dispatch Received</th>
        <th>Departure</th>
        <th>Notes</th>
        <th>Deadline (CTP)</th>
        <th>Deadline (Dispatch)</th>
        <th>Deadline (Departure)</th>
        <th>Delay (CTP)</th>
        <th>Delay (Dispatch)</th>
        <th>Delay (Departure)</th>
        <th>User</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDxE1d9nCYUTjmipUJ3zPSvtaFwypkk0bI",
  authDomain: "dispatchwebapp-66959.firebaseapp.com",
  projectId: "dispatchwebapp-66959",
  storageBucket: "dispatchwebapp-66959.appspot.com",
  messagingSenderId: "984217204226",
  appId: "1:984217204226:web:ab6efa24a54345fc57d91b"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);
const fCollection = collection(db, "dispatchRecords");

// expose functions globally
window.fAddDoc = addDoc;
window.fSetDoc = setDoc;
window.fDoc = doc;
window.db = db;
window.fCollection = fCollection;

// Sync all records to Firebase
async function syncAllToFirebase(){
  for(let rec of records){
    if(!rec.id){
      let ref = await addDoc(fCollection, rec);
      rec.id = ref.id;
    } else {
      await setDoc(doc(db,"dispatchRecords",rec.id), rec);
    }
  }
}

// Load existing records from Firebase
async function loadFromFirebase(){
  const snap = await getDocs(fCollection);
  records = [];
  snap.forEach(d=>records.push({...d.data(), id:d.id}));
  localStorage.setItem("dispatchRecords", JSON.stringify(records));
  renderTable();
}

loadFromFirebase();
</script>

<script>
  // ... All your previous JS code remains exactly the same ...
  // Just replace localStorage.setItem(...) lines with saveAll() calls
  function saveAll(){
    localStorage.setItem("dispatchRecords", JSON.stringify(records));
    syncAllToFirebase();
  }

  // Example: In add/edit/delete/clearAll
  // replace localStorage.setItem(...) with saveAll()
  // In dispatchForm submit:
  document.getElementById("dispatchForm").addEventListener("submit", function(e){
    e.preventDefault();
    const date=document.getElementById("date").value, dept=document.getElementById("department").value, sec=document.getElementById("section").value;
    const ctp=document.getElementById("pageCTP").value, dispatch=document.getElementById("dispatchReceived").value, departure=document.getElementById("departure").value;
    const departureAll=document.getElementById("departureAll").checked, dl=deadlines[dept] && deadlines[dept][sec]?deadlines[dept][sec]:{};

    if(departureAll && departure){
      records.forEach(r=>{
        if(r.date===date){
          r.departure=departure;
          r.deadlineDeparture=universalDepartureDeadline;
          r.delayDeparture=isDelayed(r.departure, universalDepartureDeadline, r.date);
        }
      });
    } else {
      let existing=records.find(r=>r.date===date&&r.department===dept&&r.section===sec);
      if(existing){
        if(ctp) existing.pageCTP=ctp;
        if(dispatch) existing.dispatchReceived=dispatch;
        if(departure) existing.departure=departure;
        if(document.getElementById("notes").value) existing.notes=document.getElementById("notes").value;
        existing.deadlineCTP=dl.ctp||"";
        existing.deadlineDispatch=dl.dispatch||"";
        existing.deadlineDeparture=universalDepartureDeadline;
        existing.delayCTP=isDelayed(existing.pageCTP,dl.ctp,date);
        existing.delayDispatch=isDelayed(existing.dispatchReceived,dl.dispatch,date);
        existing.delayDeparture=isDelayed(existing.departure,universalDepartureDeadline,date);
      } else {
        records.push({
          date, department:dept, section:sec, pageCTP:ctp, dispatchReceived:dispatch,
          departure, notes:document.getElementById("notes").value, deadlineCTP:dl.ctp||"",
          deadlineDispatch:dl.dispatch||"", deadlineDeparture:universalDepartureDeadline,
          delayCTP:isDelayed(ctp,dl.ctp,date), delayDispatch:isDelayed(dispatch,dl.dispatch,date),
          delayDeparture:isDelayed(departure,universalDepartureDeadline,date), addedBy:currentUser.username
        });
      }
    }

    saveAll(); // <-- replaces localStorage.setItem
    renderTable(); this.reset();
  });

  // Similarly, in editRecord, deleteRecord, clearAllData replace localStorage.setItem with saveAll()
</script>

</body>
</html>
